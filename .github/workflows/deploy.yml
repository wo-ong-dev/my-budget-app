name: Deploy
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KEY }}

      - name: Add host to known_hosts
        run: |
          ssh-keyscan -p 22 13.125.205.126 >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        run: |
          ssh -p 22 ec2-user@13.125.205.126 'bash -s' << "REMOTE"
          set -e
          # 1) APP_DIR 시크릿의 개행/공백 제거 후 사용
          APP_DIR_RAW='${{ secrets.APP_DIR }}'
          APP_DIR=$(printf "%s" "$APP_DIR_RAW" | tr -d '\r' | xargs)
          echo "Using APP_DIR: [$APP_DIR]"
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          # 2) 배포
          git fetch --all
          git reset --hard origin/main

          npm ci
          npm run build

          # 3) Nginx 정적 복사(있는 경우만)
          NGINX_DIR_RAW='${{ secrets.NGINX_STATIC_DIR }}'
          NGINX_DIR=$(printf "%s" "$NGINX_DIR_RAW" | tr -d '\r' | xargs)
          if [ -n "$NGINX_DIR" ] && [ -d "$NGINX_DIR" ]; then
            sudo rm -rf "$NGINX_DIR"/*
            sudo cp -r dist/* "$NGINX_DIR"/
            sudo systemctl reload nginx || true
          fi
          REMOTE

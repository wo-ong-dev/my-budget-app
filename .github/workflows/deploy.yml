name: Deploy
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: "13.125.205.126"   # 일단 하드코딩
          username: "${{ secrets.USER }}"
          key: "${{ secrets.KEY }}"
          port: "22"               # 문자열로 고정
          debug: true
          script_stop: true
          command_timeout: 30m
          script: |
            set -e
            cd ${{ secrets.APP_DIR }}
            git fetch --all
            git reset --hard origin/main

            npm ci
            npm run build

            if [ -n "${{ secrets.NGINX_STATIC_DIR }}" ] && [ -d "${{ secrets.NGINX_STATIC_DIR }}" ]; then
              sudo rm -rf "${{ secrets.NGINX_STATIC_DIR }}"/*
              sudo cp -r dist/* "${{ secrets.NGINX_STATIC_DIR }}/"
              sudo systemctl reload nginx || true
            fi

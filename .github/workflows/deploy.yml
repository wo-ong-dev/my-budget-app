name: Build and Deploy (EC2 Nginx)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          # Set if you want to override at build-time. Optional because code also uses absolute "/api" paths.
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KEY }}

      - name: Copy build to EC2 (/tmp)
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USER }}
          PORT: ${{ secrets.PORT }}
        run: |
          SSH_PORT=${PORT:-22}
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${USER}@${HOST} "mkdir -p /tmp/my-budget-app/"
          scp -P $SSH_PORT -o StrictHostKeyChecking=no -r dist/* ${USER}@${HOST}:/tmp/my-budget-app/

      - name: Publish to Nginx docroot
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USER }}
          PORT: ${{ secrets.PORT }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          SSH_PORT=${PORT:-22}
          TARGET_DIR=${APP_DIR:-/var/www/html}
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${USER}@${HOST} \
            "sudo mkdir -p $TARGET_DIR && \
             sudo rm -rf $TARGET_DIR/* && \
             sudo cp -r /tmp/my-budget-app/* $TARGET_DIR/ && \
             sudo chown -R nginx:nginx $TARGET_DIR || true && \
             if command -v systemctl >/dev/null 2>&1; then sudo systemctl restart nginx || true; fi"

 

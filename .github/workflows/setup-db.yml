name: Setup Database

on:
  workflow_dispatch:

jobs:
  setup-database:
    runs-on: ubuntu-latest
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KEY }}

      - name: Setup Database
        run: |
          set -e

          # Use secrets directly
          SSH_HOST="${{ secrets.HOST }}"
          SSH_USER="${{ secrets.USER }}"
          SSH_PORT="${{ secrets.PORT }}"

          # Clean up secrets
          SSH_HOST=$(echo "$SSH_HOST" | tr -d '[:space:]')
          SSH_USER=$(echo "$SSH_USER" | tr -d '[:space:]')
          SSH_PORT=$(echo "$SSH_PORT" | tr -d '[:space:]')

          # Remove prefixes if any
          SSH_HOST="${SSH_HOST#*:}"
          SSH_USER="${SSH_USER#*:}"
          SSH_PORT="${SSH_PORT#*:}"

          # Set defaults
          SSH_PORT=${SSH_PORT:-22}
          SSH_USER=${SSH_USER:-ec2-user}

          echo "üîç Connecting to ${SSH_USER}@${SSH_HOST}:${SSH_PORT}"

          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
            DB_HOST="${{ secrets.DB_HOST }}" \
            DB_USER="${{ secrets.DB_USER }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            DB_NAME="${{ secrets.DB_NAME }}" \
            bash << 'EOF'
            set -e

            echo "üì¶ Installing MySQL client if needed..."
            if ! command -v mysql &> /dev/null; then
              sudo yum install -y mysql || sudo apt-get install -y mysql-client
            fi

            echo "üóÑÔ∏è Setting up database..."

            # Find backend directory and read DB credentials from .env if secrets not provided
            if [ -z "$DB_HOST" ] && [ -f /var/www/backend/.env ]; then
              source /var/www/backend/.env
            elif [ -z "$DB_HOST" ] && [ -f ~/.env ]; then
              source ~/.env
            fi

            # Create SQL file
            cat > /tmp/setup_db.sql << 'EOSQL'
INSERT IGNORE INTO accounts (name, type, created_at, updated_at) VALUES
('Íµ≠ÎØºÏùÄÌñâ', 'bank', NOW(), NOW()),
('ÌÜ†Ïä§Î±ÖÌÅ¨', 'bank', NOW(), NOW()),
('Ïö∞Î¶¨ÏùÄÌñâ', 'bank', NOW(), NOW()),
('Ïã†Ïö©Ïπ¥Îìú', 'card', NOW(), NOW()),
('Ïπ¥Ïπ¥Ïò§ÌéòÏù¥', 'card', NOW(), NOW()),
('Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨', 'bank', NOW(), NOW()),
('ÌòÑÍ∏à', 'cash', NOW(), NOW());

INSERT IGNORE INTO categories (name, type, created_at, updated_at) VALUES
('Í∏âÏó¨', 'ÏàòÏûÖ', NOW(), NOW()),
('Ïö©Îèà', 'ÏàòÏûÖ', NOW(), NOW()),
('Í∑∏ Ïô∏', 'ÏàòÏûÖ', NOW(), NOW()),
('Í∏∞ÌÉÄ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÍµêÌÜµÎπÑ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Íµ¨ÎèÖ/Ìè¨Ïù∏Ìä∏', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Îç∞Ïù¥Ìä∏', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÏÉùÌôú/ÎßàÌä∏', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÏÑ†Î¨º/Í≤ΩÏ°∞ÏÇ¨ÎπÑ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÏãùÎπÑ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Ïó¨Ìñâ/ÏàôÎ∞ï', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÏõîÏÑ∏/Í¥ÄÎ¶¨ÎπÑ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Ï†ÄÏ∂ï/ÏÉÅÏ°∞/Î≥¥Ìóò', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Ïπ¥Ìéò/ÏùåÎ£å', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÌÜµÏã†ÎπÑ/Ïù∏ÌÑ∞ÎÑ∑ÎπÑ', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Ìé∏ÏùòÏ†ê', 'ÏßÄÏ∂ú', NOW(), NOW()),
('Ï∑®ÎØ∏', 'ÏßÄÏ∂ú', NOW(), NOW()),
('ÏÉÅÎÇ©Í∏à', 'ÏßÄÏ∂ú', NOW(), NOW());

SELECT 'Accounts:' as '';
SELECT * FROM accounts;
SELECT 'Categories:' as '';
SELECT * FROM categories;
EOSQL

            echo "‚úÖ SQL file created"

            # Check if DB credentials are available
            if [ ! -z "$DB_HOST" ] && [ ! -z "$DB_USER" ] && [ ! -z "$DB_PASSWORD" ] && [ ! -z "$DB_NAME" ]; then
              echo "üìä Executing SQL..."
              mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < /tmp/setup_db.sql 2>&1
              echo "‚úÖ Database setup complete!"
            else
              echo "‚ö†Ô∏è DB credentials not found in .env files or GitHub secrets"
              echo "SQL file saved at /tmp/setup_db.sql"
              echo "Please run manually with: mysql -h <host> -u <user> -p<password> <database> < /tmp/setup_db.sql"
            fi

            rm -f /tmp/setup_db.sql
EOF

          echo "‚úÖ Setup complete"
